<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=windows-1252">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
      <script type="text/javascript">

		window.binary = [":100000000C9461000C947E000C947E000C947E0095\n:100010000C947E000C947E000C947E000C947E0068\n:100020000C947E000C947E000C947E000C947E0058\n:100030000C947E000C947E000C947E000C947E0048\n:100040000C949D000C947E000C947E000C947E0019\n:100050000C947E000C947E000C947E000C947E0028\n:100060000C947E000C947E00000000002400270009\n:100070002A0000000000250028002B0000000000DE\n:1000800023002600290004040404040404040202DA\n:100090000202020203030303030301020408102007\n:1000A0004080010204081020010204081020000012\n:1000B0000007000201000003040600000000000029\n:1000C000000011241FBECFEFD8E0DEBFCDBF11E08E\n:1000D000A0E0B1E0EAE3F4E002C005900D92A230A6\n:1000E000B107D9F711E0A2E0B1E001C01D92AB3039\n:1000F000B107E1F70E940C020C941B020C94000063\n:100100008091000161E00E94B80168EE73E080E038\n:1001100090E00E94E5008091000160E00E94B8013B\n:1001200068EE73E080E090E00E94E5000895809121\n:10013000000161E00E94790108951F920F920FB6AD\n:100140000F9211242F933F938F939F93AF93BF935D\n:100150008091060190910701A0910801B0910901D9\n:1001600030910A010196A11DB11D232F2D5F2D375E\n:1001700020F02D570196A11DB11D20930A018093F7\n:10018000060190930701A0930801B09309018091A3\n:10019000020190910301A0910401B0910501019623\n:1001A000A11DB11D8093020190930301A09304014E\n:1001B000B0930501BF91AF919F918F913F912F9186\n:1001C0000F900FBE0F901F9018959B01AC017FB749\n:1001D000F8948091020190910301A0910401B091E3\n:1001E000050166B5A89B05C06F3F19F00196A11DDA\n:1001F000B11D7FBFBA2FA92F982F8827860F911D79\n:10020000A11DB11D62E0880F991FAA1FBB1F6A952F\n:10021000D1F7BC012DC0FFB7F894809102019091F5\n:100220000301A0910401B0910501E6B5A89B05C0AA\n:10023000EF3F19F00196A11DB11DFFBFBA2FA92FE5\n:10024000982F88278E0F911DA11DB11DE2E0880F08\n:10025000991FAA1FBB1FEA95D1F7861B970B885ED3\n:100260009340C8F2215030404040504068517C4F8C\n:10027000211531054105510571F60895789484B52D\n:10028000826084BD84B5816084BD85B5826085BD92\n:1002900085B5816085BDEEE6F0E080818160808378\n:1002A000E1E8F0E01082808182608083808181605B\n:1002B0008083E0E8F0E0808181608083E1EBF0E022\n:1002C000808184608083E0EBF0E0808181608083C6\n:1002D000EAE7F0E0808184608083808182608083AF\n:1002E0008081816080838081806880831092C100DA\n:1002F0000895CF93DF93482F50E0CA0186569F4F51\n:10030000FC0134914A575F4FFA018491882369F1C7\n:1003100090E0880F991FFC01E859FF4FA591B49117\n:10032000FC01EE58FF4FC591D491662351F42FB7CD\n:10033000F8948C91932F909589238C9388818923AD\n:100340000BC0623061F42FB7F8948C91932F909585\n:1003500089238C938881832B88832FBF06C09FB706\n:10036000F8948C91832B8C939FBFDF91CF9108954C\n:10037000482F50E0CA0182559F4FFC012491CA01C9\n:1003800086569F4FFC0194914A575F4FFA01349172\n:10039000332309F440C0222351F1233071F024307B\n:1003A00028F42130A1F0223011F514C02630B1F02C\n:1003B0002730C1F02430D9F404C0809180008F77B9\n:1003C00003C0809180008F7D8093800010C084B531\n:1003D0008F7702C084B58F7D84BD09C08091B00045\n:1003E0008F7703C08091B0008F7D8093B000E32FA2\n:1003F000F0E0EE0FFF1FEE58FF4FA591B4912FB71D\n:10040000F894662321F48C919095892302C08C91F5\n:10041000892B8C932FBF0895CF93DF930E943E01C9\n:100420000E949700C0E0D0E00E9480002097E1F396\n:0A0430000E940000F9CFF894FFCFFE\n:02043A000D00B3\n:00000001FF",
						 "100000000C9435000C945D000C945D000C945D0024\n:100010000C945D000C945D000C945D000C945D00EC\n:100020000C945D000C945D000C945D000C945D00DC\n:100030000C945D000C945D000C945D000C945D00CC\n:100040000C943C040C945D000C94C9000C941701B2\n:100050000C945D000C945D000C945D000C945D00AC\n:100060000C945D000C945D00850211241FBECFEF3F\n:10007000D8E0DEBFCDBF11E0A0E0B1E0E0E1FAE002\n:1000800002C005900D92AE34B107D9F712E0AEE48C\n:10009000B1E001C01D92A130B107E1F710E0CAE65E\n:1000A000D0E004C02297FE010E940205C836D107A5\n:1000B000C9F70E94DB020C9406050C94000086ED43\n:1000C00091E040E855E260E070E00E94520186ED68\n:1000D00091E00E9483028823D1F386ED91E060E0F5\n:1000E00071E00E942904089586ED91E060913C0141\n:1000F0000E94430286ED91E06CE171E00E942604CB\n:1001000060913C0170913D0186ED91E04AE050E044\n:100110000E94F40386ED91E064E271E00E942604FF\n:1001200060913C0170913D0186ED91E040E150E02D\n:100130000E94F40386ED91E06CE271E00E942604D7\n:1001400060913C0170913D0186ED91E048E050E006\n:100150000E94F40386ED91E064E371E00E942604BE\n:1001600060913C0170913D0186ED91E042E050E0EC\n:100170000E94070480913C0190913D018E379105CA\n:1001800009F4FFCF019690933D0180933C010895BF\n:1001900008951F920F920FB60F9211242F933F9341\n:1001A0004F938F939F93EF93FF938091C00082FDB5\n:1001B0001DC04091C60020918E0130918F012F5FAC\n:1001C0003F4F2F73307080919001909191012817CB\n:1001D000390771F0E0918E01F0918F01E25BFE4FE3\n:1001E000408330938F0120938E0102C08091C6001E\n:1001F000FF91EF919F918F914F913F912F910F9090\n:100200000FBE0F901F901895E091E201F091E3016D\n:10021000E05CFF4F8191919120813181821B930B92\n:100220008F739070892B11F00E94C80008951F925F\n:100230000F920FB60F9211242F933F938F939F939A\n:10024000EF93FF932091D2013091D3018091D4019B\n:100250009091D5012817390731F48091C1008F7D25\n:100260008093C10014C0E091D401F091D501EE5605\n:10027000FE4F20818091D4019091D50101968F731A\n:1002800090709093D5018093D4012093C600FF9184\n:10029000EF919F918F913F912F910F900FBE0F90F3\n:1002A0001F901895AF92BF92DF92EF92FF920F933B\n:1002B0001F93CF93DF93EC017A018B01DD24403053\n:1002C00081EE580780E0680780E0780711F0DD24B0\n:1002D000D39491E0A92EB12CEC89FD89DD2069F041\n:1002E000C50108A002C0880F991F0A94E2F7808315\n:1002F00060E079E08DE390E005C0108260E874E88A\n:100300008EE190E0A80197010E94DE042150304068\n:1003100040405040569547953795279580E12030CD\n:10032000380720F0DD2011F0DD24D6CFE889F989E7\n:100330003083EA89FB89208319A2EE89FF894081F5\n:1003400021E030E0C9010C8C02C0880F991F0A948B\n:10035000E2F7482B4083EE89FF894081C9010D8C6B\n:1003600002C0880F991F0A94E2F7482B4083EE8958\n:10037000FF894081C9010E8C02C0880F991F0A9421\n:10038000E2F7482B4083EE89FF8980810F8C02C001\n:10039000220F331F0A94E2F7209528232083DF9150\n:1003A000CF911F910F91FF90EF90DF90BF90AF9092\n:1003B0000895DC011C96ED91FC911D97E05CFF4FC8\n:1003C0002191319180819181281B390B2F733070DD\n:1003D000C9010895DC011C96ED91FC911D97E05C2C\n:1003E000FF4F20813181E054F040DF01AE5BBF4F11\n:1003F0008D919C9111972817390719F42FEF3FEF32\n:1004000007C08D919C91E80FF91F8081282F30E063\n:10041000C9010895DC011C96ED91FC911D97E05CEB\n:10042000FF4F20813181E054F040DF01AE5BBF4FD0\n:100430008D919C9111972817390719F42FEF3FEFF1\n:1004400010C08D919C911197E80FF91F20818D911B\n:100450009C91119701968F73907011969C938E9337\n:1004600030E0C9010895DC0191968C919197882321\n:1004700039F05496ED91FC915597808186FFF9CF24\n:1004800091961C920895CF93DF93EC01EE85FF8542\n:10049000E05CFF4F20813181E054F0402F5F3F4FFF\n:1004A0002F733070DF01AE5BBF4F8D919C91119720\n:1004B00028173907D1F3E05CFF4F80819181E05428\n:1004C000F040E80FF91F6083EE85FF85E05CFF4F89\n:1004D00031832083EE89FF89208181E090E00F8CB9\n:1004E00002C0880F991F0A94E2F7282B208381E02D\n:1004F00089A3EC89FD8980818064808381E090E01C\n:10050000DF91CF91089581E008951092D901109262\n:10051000D80188EE93E0A0E0B0E08093DA019093F8\n:10052000DB01A093DC01B093DD0182E491E09093C4\n:10053000D7018093D6018EE491E09093E3018093FC\n:10054000E20182E991E09093E5018093E40185EC7A\n:1005500090E09093E7018093E60184EC90E0909323\n:10056000E9018093E80180EC90E09093EB018093A7\n:10057000EA0181EC90E09093ED018093EC0182EC34\n:1005800090E09093EF018093EE0186EC90E09093E1\n:10059000F1018093F00184E08093F20183E0809385\n:1005A000F30187E08093F40185E08093F50181E019\n:1005B0008093F6010895CF93DF930E9484040E94F4\n:1005C0005F00C4E0D1E00E9474002097E1F30E9434\n:1005D0000401F9CFCF92DF92EF92FF920F931F9316\n:1005E000CF93DF937C016B018A01C0E0D0E00FC0A4\n:1005F000D6016D916D01D701ED91FC910190F081D3\n:10060000E02DC7010995C80FD91F015010400115F1\n:10061000110571F7CE01DF91CF911F910F91FF90DE\n:10062000EF90DF90CF900895EF92FF920F931F937A\n:100630008C01DC01ED91FC910190F081E02D6DE0E9\n:1006400009957C01D801ED91FC910190F081E02D9C\n:10065000C8016AE009959C012E0D3F1DC9011F913B\n:100660000F91FF90EF900895CF93DF93EC01611508\n:10067000710519F420E030E00FC0DB010D9000207F\n:10068000E9F71197A61BB70BE881F9810280F38186\n:10069000E02DAD0109959C01C901DF91CF9108952D\n:1006A0004F925F927F928F929F92AF92BF92CF9222\n:1006B000DF92EF92FF920F931F93DF93CF93CDB70B\n:1006C000DEB7A1970FB6F894DEBF0FBECDBF2C01E9\n:1006D000742ECB01223008F42AE019A231E2C32E95\n:1006E000D12CCC0EDD1E822E9924AA24BB24672D8A\n:1006F000752FA50194010E94DE0479018A01C801C9\n:10070000B701A50194010E94BF04472D461B089420\n:10071000C108D1084A3014F4405D01C0495CF601BB\n:100720004083E114F1040105110521F07E2C5F2DB9\n:10073000C801DDCFC201B6010E943403A1960FB6F5\n:10074000F894DEBF0FBECDBFCF91DF911F910F9107\n:10075000FF90EF90DF90CF90BF90AF909F908F90E1\n:100760007F905F904F900895CF92DF92EF92FF922B\n:100770000F931F93CF93DF93EC016A017B01211547\n:10078000310541F4E881F9810190F081E02D642F79\n:1007900009951FC02A303105D1F477FF17C0E881D1\n:1007A000F9810190F081E02D6DE209958C014427DB\n:1007B0005527BA014C195D096E097F09CE012AE05F\n:1007C0000E9450039801280F391F04C02AE00E949C\n:1007D00050039C01C901DF91CF911F910F91FF90B0\n:1007E000EF90DF90CF900895EF92FF920F931F93B9\n:1007F0007B019A010027F7FC0095102FB801A70193\n:100800000E94B4031F910F91FF90EF900895CF9233\n:10081000DF92EF92FF920F931F936C017B019A017D\n:100820000027F7FC0095102FB801A7010E94B40320\n:100830008C01C6010E941403080F191FC8011F91E3\n:100840000F91FF90EF90DF90CF9008950E943403B6\n:100850000895EF92FF920F931F937C010E9434033F\n:100860008C01C7010E941403080F191FC8011F91B2\n:100870000F91FF90EF9008951F920F920FB60F9275\n:1008800011242F933F938F939F93AF93BF938091A6\n:10089000FC019091FD01A091FE01B091FF0130910A\n:1008A00000020196A11DB11D232F2D5F2D3720F0D1\n:1008B0002D570196A11DB11D209300028093FC01CC\n:1008C0009093FD01A093FE01B093FF018091F80188\n:1008D0009091F901A091FA01B091FB010196A11D3F\n:1008E000B11D8093F8019093F901A093FA01B093A0\n:1008F000FB01BF91AF919F918F913F912F910F90ED\n:100900000FBE0F901F901895789484B5826084BDB7\n:1009100084B5816084BD85B5826085BD85B5816003\n:1009200085BDEEE6F0E0808181608083E1E8F0E063\n:100930001082808182608083808181608083E0E892\n:10094000F0E0808181608083E1EBF0E08081846071\n:100950008083E0EBF0E0808181608083EAE7F0E073\n:1009600080818460808380818260808380818160D7\n:1009700080838081806880831092C1000895629F87\n:10098000D001739FF001829FE00DF11D649FE00D87\n:10099000F11D929FF00D839FF00D749FF00D659FE8\n:1009A000F00D9927729FB00DE11DF91F639FB00DE7\n:1009B000E11DF91FBD01CF0111240895A1E21A2EF6\n:1009C000AA1BBB1BFD010DC0AA1FBB1FEE1FFF1FF3\n:1009D000A217B307E407F50720F0A21BB30BE40B43\n:1009E000F50B661F771F881F991F1A9469F760958A\n:1009F0007095809590959B01AC01BD01CF01089544\n:100A0000EE0FFF1F0590F491E02D0994F894FFCFAD\n:100A10004153434949205461626C65207E204368FC\n:100A200061726163746572204D6170002C20646591\n:100A3000633A20002C206865783A20002C206F63F0\n:100A4000743A20002C2062696E3A200021000000D8\n:0E0A500000004302EA02D9010A02EA01330261\n:00000001FF\n",
						 ""]
         var sock = null;
         var wsuri = "ws://localhost:9000";


         window.sock2 = null;
         var wsuri2 = "ws://localhost:9001";

		 window.oldPorts = "";

         window.onload = function() {

            sock = new WebSocket(wsuri);

            sock.onopen = function() {
               console.log("connected to " + wsuri);
				document.getElementById('connection_status').innerHTML = "CONNECTED"
				version();

				window.setInterval( function(){sock.send(JSON.stringify({"type":"ack"}));}, 500);
            }

            sock.onclose = function(e) {
				document.getElementById('connection_status').innerHTML = "DISCONNECTED"
               console.log("connection closed (" + e.code + ")");
            }

            sock.onmessage = function(e) {
               console.log("message received: " + e.data);
				var data = JSON.parse(e.data);
				if(data["type"] == "ports")
				{
					if(JSON.stringify(oldPorts) != JSON.stringify(data["ports"]))
					{
						$('#serial_select').find('option').remove();
						for (var i = 0; i < data["ports"].length; i++) 
						{
							if (data["ports"][i] != "")
							{
						    	serial_select.options[i] = new Option(data["ports"][i], data["ports"][i], true, false);
						    }
						}
						oldPorts = data["ports"];
					}
				}
				else if(data["type"] == "version")
				{
					document.getElementById('daemon_version').innerHTML = data["version"];
				}
				else if(data["type"] == "check_drivers")
				{
					if(data["installed"])
						document.getElementById('drivers').innerHTML = "INSTALLED";
					else
					document.getElementById('drivers').innerHTML = "NOT INSTALLED";
				}
				else if(data["type"] == "installation_output")
				{
					if(data["success"])
						document.getElementById('drivers').innerHTML = "INSTALLATION SUCCESSFUL";
					else
						document.getElementById('drivers').innerHTML = "INSTALLATION FAILED " + data["error"];
				}
				else if(data["type"] == "flashing_output")
				{
					if(data["retval"] == 0)
						document.getElementById('flasing_status').innerHTML = "FLASHING SUCCESSFUL";
					else
						document.getElementById('flasing_status').innerHTML = "FLASHING FAILED " + data["retval"];
				}
            }
         };

         function sendMessage(message) {
            var msg = {"type":"message","text":message};
            sock.send(JSON.stringify(msg));
         };

         function flash() {
            var msg = {"type":"flash","binary":window.binary[binaries.selectedIndex], "cpu":"atmega328p", "ptc":"arduino", "prt":serial_select.options[serial_select.selectedIndex].value, "bad":"115200"};
            sock.send(JSON.stringify(msg));
         };

         function version() {
            var msg = {"type":"version"};
            sock.send(JSON.stringify(msg));
         };

		function checkDrivers()
		{
            var msg = {"type":"check_drivers"};
            sock.send(JSON.stringify(msg));
		};

		function installDrivers()
		{
            var msg = {"type":"install_drivers"};
            sock.send(JSON.stringify(msg));
		};

        function connect() {
			if(sock2 == null)
			{
				var msg = {"type":"set_serial","port":serial_select.options[serial_select.selectedIndex].value, "baudrate":serial_baud.selectedOptions[0].text};
	           sock.send(JSON.stringify(msg));

				sock2 = new WebSocket(wsuri2);

	            sock2.onopen = function() {
	               console.log("connected to " + wsuri);
					version();
	            }

	            sock2.onclose = function(e) {
	               console.log("connection closed (" + e.code + ")");
					sock2 = null;
	            }

	            sock2.onmessage = function(e) {
					$("#serialmon").html($("#serialmon").html() + e.data);
	            }
			}
			else
			console.log("connection already open");
        };

        function disconnect() {
           // var msg = {"type":"serial_disconnect",};
           // sock.send(JSON.stringify(msg));
			$("#serialmon").html("");
			if(sock2 != null)
			{
	           sock2.close();
			}
        };

        function sendData() {
           var msg = {"type":"data","data":document.getElementById('message').value};
           sock2.send(JSON.stringify(msg));
        };
      </script>
   </head>
   <body>
      <h1>WebSocket Echo Test</h1>
		<p>
			Status: <span id="connection_status">NOT CONNECTED</span>
			WebSocket Daemon Version: <span id="daemon_version">Unknown</span> <span id="drivers"></span>
			Flashing Status: <span id="flasing_status">None</span>
		</p>
      <button onclick="version();">Version</button>
      <button onclick="checkDrivers();">Check Drivers</button>
      <button onclick="installDrivers();">Install Drivers</button>
      <br />
      <select id="binaries"><option>Blink</option><option>Serial Output</option><option>Serial Echo</option></select>
	<select id="serial_select" style="width:300px"></select>
    <button onclick="flash();">Flash</button>

	<br />
	  <button onclick="connect();">Connect</button>
      <button onclick="disconnect();">Disconnect</button>
	<select id="serial_baud" style="width:300px"><option id="9600" name=9600>9600</option></select>
	<br />
    <p>
    <form>
        Message: <input id="message" value="Hello, world!" type="text">
	    <button onclick="sendData();">Send Message</button>
    </form>
	</p>
	<p>WebSerial Monitor Input:<br />
		<pre id="serialmon" style="display: block; border: 1px solid; width:500px; height: 800px; overflow-y: scroll"></pre>
	</p>
   

</body></html>
