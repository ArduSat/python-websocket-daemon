<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=windows-1252">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
      <script type="text/javascript">

		window.binary = ":100000000C9461000C947E000C947E000C947E0095\n:100010000C947E000C947E000C947E000C947E0068\n:100020000C947E000C947E000C947E000C947E0058\n:100030000C947E000C947E000C947E000C947E0048\n:100040000C949D000C947E000C947E000C947E0019\n:100050000C947E000C947E000C947E000C947E0028\n:100060000C947E000C947E00000000002400270009\n:100070002A0000000000250028002B0000000000DE\n:1000800023002600290004040404040404040202DA\n:100090000202020203030303030301020408102007\n:1000A0004080010204081020010204081020000012\n:1000B0000007000201000003040600000000000029\n:1000C000000011241FBECFEFD8E0DEBFCDBF11E08E\n:1000D000A0E0B1E0EAE3F4E002C005900D92A230A6\n:1000E000B107D9F711E0A2E0B1E001C01D92AB3039\n:1000F000B107E1F70E940C020C941B020C94000063\n:100100008091000161E00E94B80168EE73E080E038\n:1001100090E00E94E5008091000160E00E94B8013B\n:1001200068EE73E080E090E00E94E5000895809121\n:10013000000161E00E94790108951F920F920FB6AD\n:100140000F9211242F933F938F939F93AF93BF935D\n:100150008091060190910701A0910801B0910901D9\n:1001600030910A010196A11DB11D232F2D5F2D375E\n:1001700020F02D570196A11DB11D20930A018093F7\n:10018000060190930701A0930801B09309018091A3\n:10019000020190910301A0910401B0910501019623\n:1001A000A11DB11D8093020190930301A09304014E\n:1001B000B0930501BF91AF919F918F913F912F9186\n:1001C0000F900FBE0F901F9018959B01AC017FB749\n:1001D000F8948091020190910301A0910401B091E3\n:1001E000050166B5A89B05C06F3F19F00196A11DDA\n:1001F000B11D7FBFBA2FA92F982F8827860F911D79\n:10020000A11DB11D62E0880F991FAA1FBB1F6A952F\n:10021000D1F7BC012DC0FFB7F894809102019091F5\n:100220000301A0910401B0910501E6B5A89B05C0AA\n:10023000EF3F19F00196A11DB11DFFBFBA2FA92FE5\n:10024000982F88278E0F911DA11DB11DE2E0880F08\n:10025000991FAA1FBB1FEA95D1F7861B970B885ED3\n:100260009340C8F2215030404040504068517C4F8C\n:10027000211531054105510571F60895789484B52D\n:10028000826084BD84B5816084BD85B5826085BD92\n:1002900085B5816085BDEEE6F0E080818160808378\n:1002A000E1E8F0E01082808182608083808181605B\n:1002B0008083E0E8F0E0808181608083E1EBF0E022\n:1002C000808184608083E0EBF0E0808181608083C6\n:1002D000EAE7F0E0808184608083808182608083AF\n:1002E0008081816080838081806880831092C100DA\n:1002F0000895CF93DF93482F50E0CA0186569F4F51\n:10030000FC0134914A575F4FFA018491882369F1C7\n:1003100090E0880F991FFC01E859FF4FA591B49117\n:10032000FC01EE58FF4FC591D491662351F42FB7CD\n:10033000F8948C91932F909589238C9388818923AD\n:100340000BC0623061F42FB7F8948C91932F909585\n:1003500089238C938881832B88832FBF06C09FB706\n:10036000F8948C91832B8C939FBFDF91CF9108954C\n:10037000482F50E0CA0182559F4FFC012491CA01C9\n:1003800086569F4FFC0194914A575F4FFA01349172\n:10039000332309F440C0222351F1233071F024307B\n:1003A00028F42130A1F0223011F514C02630B1F02C\n:1003B0002730C1F02430D9F404C0809180008F77B9\n:1003C00003C0809180008F7D8093800010C084B531\n:1003D0008F7702C084B58F7D84BD09C08091B00045\n:1003E0008F7703C08091B0008F7D8093B000E32FA2\n:1003F000F0E0EE0FFF1FEE58FF4FA591B4912FB71D\n:10040000F894662321F48C919095892302C08C91F5\n:10041000892B8C932FBF0895CF93DF930E943E01C9\n:100420000E949700C0E0D0E00E9480002097E1F396\n:0A0430000E940000F9CFF894FFCFFE\n:02043A000D00B3\n:00000001FF"
         var sock = null;
         var wsuri = "ws://localhost:9000";


         window.sock2 = null;
         var wsuri2 = "ws://localhost:9001";

		 window.oldPorts = "";

         window.onload = function() {

            sock = new WebSocket(wsuri);

            sock.onopen = function() {
               console.log("connected to " + wsuri);
				version();

				window.setInterval( function(){sock.send(JSON.stringify({"type":"ack"}));}, 500);
            }

            sock.onclose = function(e) {
               console.log("connection closed (" + e.code + ")");
            }

            sock.onmessage = function(e) {
               console.log("message received: " + e.data);
				var data = JSON.parse(e.data);
				if(data["type"] == "ports")
				{
					if(JSON.stringify(oldPorts) != JSON.stringify(data["ports"]))
					{
						$('#serial_select').find('option').remove();
						for (var i = 0; i < data["ports"].length; i++) 
						{
							if (data["ports"][i] != "")
							{
						    	serial_select.options[i] = new Option(data["ports"][i], data["ports"][i], true, false);
						    }
						}
						oldPorts = data["ports"];
					}
				}
				else if(data["type"] == "version")
				{
					document.getElementById('daemon_version').innerHTML = data["version"];
				}
				else if(data["type"] == "check_drivers")
				{
					if(data["installed"])
						document.getElementById('drivers').innerHTML = "INSTALLED";
					else
					document.getElementById('drivers').innerHTML = "NOT INSTALLED";
				}
				else if(data["type"] == "installation_output")
				{
					if(data["success"])
						document.getElementById('drivers').innerHTML = "INSTALLATION SUCCESSFUL";
					else
						document.getElementById('drivers').innerHTML = "INSTALLATION FAILED " + data["error"];
				}
            }
         };

         function sendMessage(message) {
            var msg = {"type":"message","text":message};
            sock.send(JSON.stringify(msg));
         };

         function flash() {
            var msg = {"type":"flash","binary":window.binary, "cpu":"atmega328p", "ptc":"arduino", "prt":serial_select.selectedOptions[0].text, "bad":"115200"};
            sock.send(JSON.stringify(msg));
         };

         function version() {
            var msg = {"type":"version"};
            sock.send(JSON.stringify(msg));
         };

		function checkDrivers()
		{
            var msg = {"type":"check_drivers"};
            sock.send(JSON.stringify(msg));
		};

		function installDrivers()
		{
            var msg = {"type":"install_drivers"};
            sock.send(JSON.stringify(msg));
		};

        function connect() {
			if(sock2 == null)
			{
				var msg = {"type":"set_serial","port":serial_select.selectedOptions[0].text, "baudrate":serial_baud.selectedOptions[0].text};
	           sock.send(JSON.stringify(msg));

				sock2 = new WebSocket(wsuri2);

	            sock2.onopen = function() {
	               console.log("connected to " + wsuri);
					version();
	            }

	            sock2.onclose = function(e) {
	               console.log("connection closed (" + e.code + ")");
					sock2 = null;
	            }

	            sock2.onmessage = function(e) {
					$("#serialmon").html($("#serialmon").html() + e.data);
	            }
			}
			else
			console.log("connection already open");
        };

        function disconnect() {
           // var msg = {"type":"serial_disconnect",};
           // sock.send(JSON.stringify(msg));
			if(sock2 != null)
			{
	           sock2.close();
			}
        };

        function sendData() {
           var msg = {"type":"data","data":document.getElementById('message').value};
           sock2.send(JSON.stringify(msg));
        };
      </script>
   </head>
   <body>
      <h1>WebSocket Echo Test</h1>
      <form>
		<p>
			WebSocket Daemon Version: <span id="daemon_version">Unknown</span> <span id="drivers"></span>
		</p>
         <p>
            Message: <input id="message" value="Hello, world!" type="text">
         </p>
      </form>
      <button onclick="flash();">Flash</button>
      <button onclick="version();">Version</button>
      <button onclick="checkDrivers();">Check Drivers</button>
      <button onclick="installDrivers();">Install Drivers</button>
	<select id="serial_select" style="width:300px"></select>

	<br />
	  <button onclick="connect();">Connect</button>
      <button onclick="disconnect();">Disconnect</button>
      <button onclick="sendData();">Send Message</button>
	<select id="serial_baud" style="width:300px"><option id="9600" name=9600>9600</option></select>
	<pre id="serialmon" style="display: block; border: 1px solid; width:500px; height: 800px; overflow-y: scroll">WebSerial Monitor Input:</pre>
   

</body></html>
